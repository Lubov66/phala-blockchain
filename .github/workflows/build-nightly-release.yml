name: Build release

on:
  [push]

env:
  CARGO_TERM_COLOR: always

jobs:
  build-core:
    name: Build core
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v3
        with:
          submodules: 'true'
      - uses: ./.github/actions/build-core
        with:
          profile: release
  build-pruntime:
    name: Build pruntime
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v3
        with:
          submodules: 'true'
      - uses: ./.github/actions/build-pruntime
  publish:
    needs: [ build-core, build-pruntime ]
    name: Pack and publish
    runs-on: ubuntu-20.04
    steps:
      - uses: actions/checkout@v3
      - name: Get current date
        id: date
        run: echo "::set-output name=date::$(date +'%Y-%m-%d')"

      - name: Download artifacts
        uses: actions/download-artifact@v3
        with:
          path: ./dist

      - name: Release
        uses: softprops/action-gh-release@v1
        env:
          TAG_NAME: nightly-${{ steps.date.outputs.date }}
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag_name: ${{ env.TAG_NAME }}
          prerelease: true
          body: Nighty build
          files: |
            ./dist/pruntime-binaries/pruntime
            ./dist/core-blockchain-binaries/phala-node
            ./dist/core-blockchain-binaries/pherry
            ./e2e/res/system.contract
            ./e2e/res/log_server.contract
            ./e2e/res/sidevm_deployer.contract
            ./e2e/res/tokenomic.contract
      - name: Delete older nightly releases
        uses: Phala-Network/delete-older-releases
        with:
          keep_latest: 1
          delete_tag_pattern: nightly
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
